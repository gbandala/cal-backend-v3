# ‚ö° README Funcional - Cal Backend v3

> **Gu√≠a completa de funcionalidades, casos de uso y flujos de trabajo**

## üìã Tabla de Contenidos

1. [Visi√≥n General del Sistema](#-visi√≥n-general-del-sistema)
2. [Funcionalidades Principales](#-funcionalidades-principales)
3. [Flujos de Trabajo](#-flujos-de-trabajo)
4. [Casos de Uso Detallados](#-casos-de-uso-detallados)
5. [Integraci√≥n con Google](#-integraci√≥n-con-google)
6. [Gesti√≥n de Calendarios Espec√≠ficos](#-gesti√≥n-de-calendarios-espec√≠ficos)
7. [Manejo de Zonas Horarias](#-manejo-de-zonas-horarias)
8. [Estados y Transiciones](#-estados-y-transiciones)
9. [Reglas de Negocio](#-reglas-de-negocio)
10. [Escenarios Avanzados](#-escenarios-avanzados)

## üéØ Visi√≥n General del Sistema

Cal Backend v3 es un **sistema completo de gesti√≥n de calendarios** dise√±ado para automatizar la programaci√≥n de reuniones, similar a **Calendly**. El sistema permite a los usuarios crear tipos de eventos personalizados, gestionar su disponibilidad y programar reuniones autom√°ticamente con integraci√≥n completa a Google Calendar.

### üé® Filosof√≠a de Dise√±o

- **Simplicidad**: Interfaz intuitiva tanto para organizadores como invitados
- **Flexibilidad**: Configuraci√≥n granular de horarios y tipos de eventos
- **Automatizaci√≥n**: M√≠nima intervenci√≥n manual en el proceso de programaci√≥n
- **Integraci√≥n**: Sincronizaci√≥n bidireccional con calendarios externos
- **Escalabilidad**: Arquitectura preparada para m√∫ltiples usuarios y eventos

## üöÄ Funcionalidades Principales

### 1. üë§ Gesti√≥n de Usuarios

#### Registro y Autenticaci√≥n
- **Registro completo** con validaci√≥n de email √∫nico
- **Generaci√≥n autom√°tica de username** basado en nombre y apellido
- **Autenticaci√≥n JWT** con tokens de larga duraci√≥n
- **Hash seguro de contrase√±as** con bcrypt y salt
- **Validaci√≥n robusta** de datos de entrada

#### Perfil de Usuario
- **Informaci√≥n personal**: Nombre, apellido, email, zona horaria
- **Configuraciones**: Zona horaria por defecto, idioma preferido
- **Estado de integraciones**: Google Calendar, Zoom, Microsoft (preparado)
- **URLs p√∫blicas**: Username √∫nico para compartir eventos

### 2. üìÖ Gesti√≥n de Eventos (Event Types)

#### Creaci√≥n de Tipos de Eventos
- **T√≠tulo y descripci√≥n** personalizables
- **Duraci√≥n variable**: Desde 15 minutos hasta varias horas
- **Privacidad configurable**: P√∫blico o privado
- **Tipos de ubicaci√≥n**: Google Meet, Zoom, presencial, personalizado
- **URLs amigables**: Slugs √∫nicos generados autom√°ticamente

#### Configuraci√≥n Avanzada
- **Calendario espec√≠fico**: Asignaci√≥n a calendarios particulares de Google
- **Buffer time**: Tiempo entre reuniones para preparaci√≥n
- **Horarios personalizados**: Por tipo de evento si es necesario
- **Preguntas personalizadas**: Para recopilar informaci√≥n adicional

#### Estados de Eventos
- **Activo/Inactivo**: Control de disponibilidad p√∫blica
- **Archivado**: Mantener historial sin mostrar p√∫blicamente
- **Eliminaci√≥n en cascada**: Al eliminar, cancela reuniones programadas

### 3. ‚è∞ Gesti√≥n de Horarios

#### Configuraci√≥n de Disponibilidad
- **Por d√≠a de la semana**: Configuraci√≥n independiente para cada d√≠a
- **Horarios flexibles**: M√∫ltiples bloques de tiempo por d√≠a
- **Zonas horarias**: Soporte completo IANA con conversi√≥n autom√°tica
- **Buffer time**: Tiempo de preparaci√≥n entre reuniones
- **D√≠as no disponibles**: Configuraci√≥n de d√≠as libres o vacaciones

#### C√°lculo de Slots Disponibles
- **Algoritmo inteligente** que considera:
  - Horarios configurados por el usuario
  - Reuniones ya programadas
  - Buffer time entre eventos
  - Duraci√≥n del tipo de evento
  - Zona horaria del invitado

#### Manejo de Excepciones
- **D√≠as espec√≠ficos**: Sobrescribir horarios para fechas particulares
- **Vacaciones**: Bloqueo de per√≠odos completos
- **Eventos externos**: Integraci√≥n con calendario de Google para evitar conflictos

### 4. üìã Gesti√≥n de Reuniones

#### Programaci√≥n de Reuniones
- **Interfaz p√∫blica**: Sin necesidad de autenticaci√≥n para invitados
- **Validaci√≥n en tiempo real**: Verificaci√≥n de disponibilidad al programar
- **Informaci√≥n del invitado**: Nombre, email, zona horaria, notas
- **Creaci√≥n autom√°tica**: Event en Google Calendar con detalles completos
- **Enlaces de reuni√≥n**: Generaci√≥n autom√°tica de Google Meet

#### Estados de Reuniones
- **Programada (scheduled)**: Reuni√≥n confirmada y creada en calendario
- **Cancelada (cancelled)**: Reuni√≥n cancelada, removida del calendario
- **Completada (completed)**: Reuni√≥n finalizada (autom√°tico despu√©s de la fecha)
- **No presentado (no_show)**: Marcado manualmente si el invitado no asiste

#### Notificaciones y Recordatorios
- **Email de confirmaci√≥n**: Autom√°tico al programar
- **Recordatorios**: 24 horas y 1 hora antes (configurado en Google Calendar)
- **Cancelaci√≥n**: Notificaci√≥n autom√°tica a ambas partes
- **Informaci√≥n de acceso**: Enlaces de Google Meet incluidos

### 5. üîó Integraciones Externas

#### Google Calendar Integration
- **OAuth2 completo**: Autorizaci√≥n segura con scopes espec√≠ficos
- **Calendarios m√∫ltiples**: Acceso a todos los calendarios del usuario
- **Sincronizaci√≥n bidireccional**: Crear y eliminar eventos
- **Refresh autom√°tico**: Gesti√≥n transparente de tokens
- **Manejo de errores**: Reconexi√≥n autom√°tica en caso de problemas

#### Google Meet Integration
- **Enlaces autom√°ticos**: Generaci√≥n de links √∫nicos para cada reuni√≥n
- **Configuraci√≥n autom√°tica**: A√±adido a eventos de Google Calendar
- **Acceso directo**: URLs incluidas en emails de confirmaci√≥n

#### Preparado para Futuras Integraciones
- **Zoom**: Estructura preparada para integraci√≥n
- **Microsoft Teams**: OAuth y endpoints listos
- **Outlook Calendar**: Compatibilidad planificada

## üîÑ Flujos de Trabajo

### Flujo 1: Registro y Configuraci√≥n Inicial

```mermaid
graph TD
    A[Usuario se registra] --> B[Confirma email]
    B --> C[Completa perfil]
    C --> D[Conecta Google Calendar]
    D --> E[Configura horarios]
    E --> F[Crea primer evento]
    F --> G[Comparte URL p√∫blica]
```

**Pasos detallados:**

1. **Registro**: Email, contrase√±a, nombre, apellido
2. **Perfil**: Zona horaria, configuraciones personales
3. **OAuth Google**: Autorizaci√≥n para Calendar y Meet
4. **Horarios**: Configuraci√≥n de disponibilidad semanal
5. **Primer evento**: Creaci√≥n de tipo de evento b√°sico
6. **Compartir**: URL p√∫blica lista para usar

### Flujo 2: Programaci√≥n de Reuni√≥n por Invitado

```mermaid
graph TD
    A[Invitado accede a URL] --> B[Ve informaci√≥n del evento]
    B --> C[Selecciona fecha]
    C --> D[Ve slots disponibles]
    D --> E[Selecciona horario]
    E --> F[Completa informaci√≥n]
    F --> G[Confirma reuni√≥n]
    G --> H[Recibe confirmaci√≥n]
    H --> I[Evento creado en Google Calendar]
```

**Pasos detallados:**

1. **Acceso p√∫blico**: Sin autenticaci√≥n requerida
2. **Informaci√≥n**: Descripci√≥n del evento, duraci√≥n, tipo
3. **Calendario**: Interfaz de selecci√≥n de fecha
4. **Slots**: Horarios disponibles en zona horaria del invitado
5. **Datos**: Nombre, email, zona horaria, notas opcionales
6. **Confirmaci√≥n**: Validaci√≥n final y programaci√≥n
7. **Notificaci√≥n**: Email autom√°tico con detalles
8. **Sincronizaci√≥n**: Creaci√≥n en Google Calendar del organizador

### Flujo 3: Gesti√≥n de Reuniones por Organizador

```mermaid
graph TD
    A[Organizador ve dashboard] --> B[Lista de reuniones]
    B --> C{Acci√≥n requerida?}
    C -->|Cancelar| D[Cancela reuni√≥n]
    C -->|Reagendar| E[Modifica fecha]
    C -->|Completar| F[Marca como completada]
    D --> G[Notifica invitado]
    E --> H[Actualiza calendario]
    F --> I[Actualiza estado]
```

## üìñ Casos de Uso Detallados

### Caso 1: Consultor Freelance

**Personaje**: Mar√≠a, consultora de marketing digital

**Necesidades**:
- Reuniones de 30 minutos con clientes potenciales
- Consultas de 60 minutos con clientes existentes
- Horarios flexibles con algunos d√≠as libres
- Integraci√≥n con su calendario personal

**Configuraci√≥n**:
```json
{
  "eventos": [
    {
      "titulo": "Consulta Inicial Gratuita",
      "duracion": 30,
      "descripcion": "Reuni√≥n para conocer tus necesidades de marketing",
      "privacidad": "publico",
      "calendario": "trabajo@gmail.com"
    },
    {
      "titulo": "Sesi√≥n de Consultor√≠a",
      "duracion": 60,
      "descripcion": "Consultor√≠a estrat√©gica personalizada",
      "privacidad": "publico",
      "calendario": "trabajo@gmail.com"
    }
  ],
  "horarios": {
    "lunes": { "inicio": "09:00", "fin": "17:00", "buffer": 15 },
    "martes": { "inicio": "09:00", "fin": "17:00", "buffer": 15 },
    "miercoles": { "disponible": false },
    "jueves": { "inicio": "10:00", "fin": "16:00", "buffer": 15 },
    "viernes": { "inicio": "09:00", "fin": "15:00", "buffer": 15 }
  }
}
```

**URLs compartidas**:
- `cal.empresa.com/maria-garcia/consulta-inicial-gratuita`
- `cal.empresa.com/maria-garcia/sesion-consultoria`

### Caso 2: Equipo de Ventas

**Personaje**: Equipo de ventas de software B2B

**Necesidades**:
- Demos de producto de 45 minutos
- Llamadas de seguimiento de 30 minutos
- M√∫ltiples representantes con horarios diferentes
- Integraci√≥n con CRM (futuro)

**Configuraci√≥n por representante**:
```json
{
  "eventos_compartidos": [
    {
      "titulo": "Demo del Producto",
      "duracion": 45,
      "descripcion": "Demostraci√≥n personalizada de nuestra plataforma",
      "preguntas": [
        "Tama√±o de su empresa",
        "Presupuesto aproximado",
        "Urgencia de implementaci√≥n"
      ]
    }
  ]
}
```

### Caso 3: Centro M√©dico

**Personaje**: Cl√≠nica m√©dica con m√∫ltiples especialistas

**Necesidades**:
- Citas de diferentes duraciones seg√∫n especialidad
- Horarios espec√≠ficos por doctor
- Salas de consulta espec√≠ficas
- Integraci√≥n con sistema de historiales

**Configuraci√≥n**:
```json
{
  "doctores": [
    {
      "nombre": "Dr. Garc√≠a - Medicina General",
      "eventos": [
        {
          "titulo": "Consulta General",
          "duracion": 30,
          "ubicacion": "Consultorio 1",
          "calendario": "consultorio1@clinica.com"
        }
      ]
    },
    {
      "nombre": "Dra. L√≥pez - Cardiolog√≠a",
      "eventos": [
        {
          "titulo": "Consulta Cardiol√≥gica",
          "duracion": 45,
          "ubicacion": "Consultorio 3",
          "calendario": "cardio@clinica.com"
        }
      ]
    }
  ]
}
```

## üîó Integraci√≥n con Google

### Configuraci√≥n OAuth2

#### Scopes Requeridos
```javascript
const GOOGLE_SCOPES = [
  'https://www.googleapis.com/auth/calendar',
  'https://www.googleapis.com/auth/calendar.events'
];
```

#### Flujo de Autorizaci√≥n
1. **Redirect a Google**: Usuario autoriza acceso a calendarios
2. **Callback handling**: Intercambio de c√≥digo por tokens
3. **Almacenamiento seguro**: Tokens encriptados en base de datos
4. **Refresh autom√°tico**: Renovaci√≥n transparente de access tokens

### Gesti√≥n de Calendarios

#### Listado de Calendarios
```javascript
// Ejemplo de respuesta de Google Calendar API
{
  "calendars": [
    {
      "id": "primary",
      "summary": "Personal",
      "description": "Calendario principal",
      "accessRole": "owner",
      "primary": true
    },
    {
      "id": "trabajo@empresa.com",
      "summary": "Trabajo",
      "description": "Calendario corporativo",
      "accessRole": "owner",
      "primary": false
    }
  ]
}
```

#### Creaci√≥n de Eventos
```javascript
// Estructura de evento creado en Google Calendar
{
  "summary": "Consulta de 30 minutos - Mar√≠a Garc√≠a",
  "description": "Reuni√≥n programada a trav√©s de Cal Backend\n\nNotas del invitado: Necesito ayuda con estrategia de redes sociales",
  "start": {
    "dateTime": "2025-06-17T09:00:00-06:00",
    "timeZone": "America/Mexico_City"
  },
  "end": {
    "dateTime": "2025-06-17T09:30:00-06:00",
    "timeZone": "America/Mexico_City"
  },
  "attendees": [
    {
      "email": "invitado@ejemplo.com",
      "displayName": "Mar√≠a Garc√≠a",
      "responseStatus": "accepted"
    }
  ],
  "conferenceData": {
    "createRequest": {
      "requestId": "unique-request-id"
    }
  }
}
```

## üìÖ Gesti√≥n de Calendarios Espec√≠ficos

### Problema Resuelto en v3

**Antes (v2)**: Todos los eventos se creaban en el calendario "primary"
**Ahora (v3)**: Cada tipo de evento puede asignarse a un calendario espec√≠fico

### Beneficios

1. **Organizaci√≥n**: Separar eventos personales de profesionales
2. **Compartir**: Diferentes calendarios para diferentes audiencias
3. **Permisos**: Control granular de acceso
4. **Sincronizaci√≥n**: Integraci√≥n con calendarios de equipo

### Implementaci√≥n

#### Selecci√≥n de Calendario por Evento
```typescript
interface EventType {
  id: string;
  title: string;
  duration: number;
  calendarId: string; // Espec√≠fico de Google Calendar
  // ... otros campos
}
```

#### Validaci√≥n de Calendarios
- **Verificaci√≥n de permisos**: Solo calendarios con acceso de escritura
- **Validaci√≥n de existencia**: Calendarios activos y accesibles
- **Fallback inteligente**: Usar "primary" si el calendario no est√° disponible

## üåç Manejo de Zonas Horarias

### Estrategia Completa

#### Almacenamiento
- **UTC en base de datos**: Todos los timestamps en UTC
- **IANA timezone names**: Soporte completo para zonas horarias
- **Configuraci√≥n por usuario**: Zona horaria por defecto

#### Conversi√≥n Autom√°tica
```typescript
// Ejemplo de conversi√≥n
const userTimezone = 'America/Mexico_City';
const inviteeTimezone = 'Europe/Madrid';

// Slot disponible en UTC
const slotUTC = '2025-06-17T15:00:00.000Z';

// Mostrar al usuario en su zona horaria
const slotUserTZ = convertToTimezone(slotUTC, userTimezone);
// Resultado: '2025-06-17T09:00:00-06:00'

// Mostrar al invitado en su zona horaria
const slotInviteeTZ = convertToTimezone(slotUTC, inviteeTimezone);
// Resultado: '2025-06-17T17:00:00+02:00'
```

#### Casos Especiales
- **Cambio de horario**: Manejo autom√°tico de DST (Daylight Saving Time)
- **Zonas horarias inv√°lidas**: Fallback a UTC con advertencia
- **Conversi√≥n en tiempo real**: Al mostrar slots disponibles

## üìä Estados y Transiciones

### Estados de Usuario
```mermaid
stateDiagram-v2
    [*] --> Registrado
    Registrado --> Verificado: confirma_email
    Verificado --> Configurado: completa_perfil
    Configurado --> Conectado: autoriza_google
    Conectado --> Activo: crea_primer_evento
    Activo --> Inactivo: desactiva_cuenta
    Inactivo --> Activo: reactiva_cuenta
```

### Estados de Event Type
```mermaid
stateDiagram-v2
    [*] --> Borrador
    Borrador --> Activo: publica_evento
    Activo --> Inactivo: desactiva_evento
    Inactivo --> Activo: reactiva_evento
    Activo --> Archivado: archiva_evento
    Inactivo --> Archivado: archiva_evento
    Archivado --> [*]: elimina_evento
```

### Estados de Reuni√≥n
```mermaid
stateDiagram-v2
    [*] --> Programada
    Programada --> Cancelada: cancela_reunion
    Programada --> Completada: fecha_pasada
    Programada --> NoShow: marca_ausencia
    Cancelada --> [*]
    Completada --> [*]
    NoShow --> [*]
```

## ‚öñÔ∏è Reglas de Negocio

### Validaciones de Programaci√≥n

#### 1. Disponibilidad de Horarios
- **Buffer time**: Respetado entre reuniones consecutivas
- **Horarios configurados**: Solo dentro de ventanas disponibles
- **Conflictos**: Verificaci√≥n con eventos existentes en Google Calendar
- **Anticipaci√≥n m√≠nima**: No permitir programar con menos de X horas de anticipaci√≥n

#### 2. Limitaciones de Tiempo
- **Duraci√≥n m√≠nima**: 15 minutos
- **Duraci√≥n m√°xima**: 8 horas (configurable)
- **Slots v√°lidos**: Alineados con intervalos configurados
- **Fin de d√≠a**: No programar reuniones que excedan horario laboral

#### 3. Validaciones de Datos
- **Email √∫nico**: No permitir duplicados en reuniones del mismo d√≠a
- **Informaci√≥n requerida**: Nombre y email siempre obligatorios
- **Zona horaria**: Validaci√≥n de nombres IANA
- **Fechas**: No permitir programar en fechas pasadas

### Pol√≠ticas de Cancelaci√≥n

#### Cancelaci√≥n por Organizador
- **Notificaci√≥n autom√°tica**: Email al invitado
- **Eliminaci√≥n de Google Calendar**: Autom√°tica
- **Registro de auditor√≠a**: Timestamp y raz√≥n

#### Cancelaci√≥n por Invitado
- **URL de cancelaci√≥n**: Incluida en email de confirmaci√≥n
- **L√≠mite de tiempo**: Configurable (ej: hasta 2 horas antes)
- **Notificaci√≥n al organizador**: Email autom√°tico

## üéØ Escenarios Avanzados

### Escenario 1: Reuniones Recurrentes (Futuro)

**Necesidad**: Algunas reuniones necesitan repetirse semanalmente

**Implementaci√≥n planificada**:
- **Patrones de recurrencia**: Semanal, quincenal, mensual
- **L√≠mite de instancias**: N√∫mero m√°ximo de repeticiones
- **Excepciones**: Saltar fechas espec√≠ficas
- **Cancelaci√≥n en cascada**: Opci√≥n de cancelar toda la serie

### Escenario 2: Equipos y Disponibilidad Compartida

**Necesidad**: M√∫ltiples personas pueden atender el mismo tipo de evento

**Implementaci√≥n planificada**:
```typescript
interface TeamEvent {
  id: string;
  title: string;
  teamMembers: string[]; // IDs de usuarios
  assignmentStrategy: 'round_robin' | 'least_busy' | 'manual';
  requiresApproval: boolean;
}
```

### Escenario 3: Salas de Reuni√≥n F√≠sicas

**Necesidad**: Reserva de espacios f√≠sicos para reuniones presenciales

**Implementaci√≥n planificada**:
```typescript
interface Room {
  id: string;
  name: string;
  capacity: number;
  equipment: string[];
  calendarId: string; // Calendar de la sala
}

interface EventType {
  // ... campos existentes
  locationType: 'google_meet' | 'zoom' | 'in_person' | 'phone';
  roomId?: string; // Para reuniones presenciales
}
```

### Escenario 4: Integraci√≥n con Sistemas de Pago

**Necesidad**: Cobrar por algunas consultas o servicios

**Implementaci√≥n planificada**:
```typescript
interface PaidEvent {
  // ... campos de EventType
  isPaid: boolean;
  price: number;
  currency: string;
  paymentMethods: ('stripe' | 'paypal')[];
  requiresPaymentBeforeBooking: boolean;
}
```

### Escenario 5: Analytics y Reportes

**Necesidad**: M√©tricas sobre uso, conversi√≥n y efectividad

**M√©tricas planificadas**:
- **Tasa de conversi√≥n**: Visitas vs reuniones programadas
- **Tipos de evento populares**: M√°s solicitados
- **Horarios preferidos**: Patrones de programaci√≥n
- **Geolocalizaci√≥n**: Zonas horarias de invitados
- **Cancelaciones**: Razones y patrones

## üîÆ Roadmap Funcional

### Q3 2025
- ‚úÖ **Calendarios espec√≠ficos**: Implementado
- ‚úÖ **Manejo de zonas horarias**: Completado
- üöß **Cache de calendarios**: En desarrollo
- üöß **Dashboard multi-calendario**: En desarrollo

### Q4 2025
- üìã **Reuniones recurrentes**: Planificado
- üìã **Equipos y disponibilidad compartida**: Planificado
- üìã **Integraci√≥n con Zoom**: Planificado
- üìã **Webhooks para integraciones**: Planificado

### Q1 2026
- üìã **Salas de reuni√≥n f√≠sicas**: Planificado
- üìã **Analytics avanzados**: Planificado
- üìã **API p√∫blica completa**: Planificado
- üìã **Integraci√≥n con sistemas de pago**: Planificado

---

**üéØ Cal Backend v3** est√° dise√±ado para crecer y adaptarse a las necesidades cambiantes de gesti√≥n de calendarios, manteniendo siempre la simplicidad y eficiencia como principios fundamentales.

*√öltima actualizaci√≥n: Junio 2025*